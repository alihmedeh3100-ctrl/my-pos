<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ูุงุดูุฑ ุงููุญู - ุงููุจูุนุงุช</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>body { font-family: 'Cairo', sans-serif; }</style>
</head>
<body class="bg-gray-50 min-h-screen">

    <header class="bg-blue-700 text-white p-4 flex justify-between shadow-lg mb-6">
        <h1 class="text-xl font-bold">๐ ูุงุดูุฑ ุงููุญู</h1>
        <div class="flex gap-4 text-sm font-bold">
            <a href="inventory.html" class="bg-blue-900 px-3 py-1 rounded hover:bg-blue-800">๐ฆ ุงููุฎุฒู</a>
            <a href="funds.html" class="bg-blue-900 px-3 py-1 rounded hover:bg-blue-800">๐ฐ ุงูุตูุฏูู</a>
            <button onclick="logoutSession()" class="bg-red-500 px-3 py-1 rounded hover:bg-red-600">ุฎุฑูุฌ</button>
        </div>
    </header>

    <main class="max-w-6xl mx-auto p-4 grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
            <div class="flex gap-4 mb-6">
                <select id="saleType" class="border p-3 rounded-xl font-bold bg-gray-50 outline-none">
                    <option value="retail">ูุจูุน ููุฑู</option>
                    <option value="wholesale">ูุจูุน ุฌููุฉ</option>
                </select>
                <input id="barcodeInput" type="text" placeholder="ุงูุณุญ ุงูุจุงุฑููุฏ ูุงุถุบุท Enter" 
                    class="flex-1 border-2 border-blue-500 p-3 rounded-xl outline-none shadow-sm focus:ring-4 focus:ring-blue-100">
            </div>

            <table class="w-full text-right">
                <thead class="bg-gray-100 text-gray-600 border-b">
                    <tr>
                        <th class="p-3">ุงููุทุนุฉ</th>
                        <th class="p-3 text-center">ุงูุณุนุฑ</th>
                        <th class="p-3 text-center">ุญุฐู</th>
                    </tr>
                </thead>
                <tbody id="cartTable" class="divide-y">
                    </tbody>
            </table>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-lg border-t-8 border-green-500 flex flex-col justify-between h-fit">
            <div>
                <h2 class="text-xl font-bold mb-4 text-slate-800">ุงูุฏูุน ุงูููุงุฆู</h2>
                <label class="text-xs text-gray-400">ุทุฑููุฉ ุงุณุชูุงู ุงููุงู:</label>
                <select id="fundMethod" class="w-full border p-4 rounded-xl font-bold text-green-700 bg-green-50 mb-6 outline-none">
                    <option value="cash">ููุฏู (Cash)</option>
                    <option value="wish">Wish Money</option>
                    <option value="plus">Cash Plus</option>
                    <option value="mobi">Mobitek</option>
                </select>

                <div class="border-t pt-4 space-y-2">
                    <div class="flex justify-between text-gray-500">
                        <span>ุงูุนุฏุฏ:</span>
                        <span id="itemsCount" class="font-bold">0</span>
                    </div>
                    <div class="flex justify-between text-3xl font-black text-blue-800">
                        <span>ุงูุฅุฌูุงูู:</span>
                        <span id="totalDisplay">0.00 $</span>
                    </div>
                </div>
            </div>

            <button onclick="confirmTransaction()" class="w-full bg-green-600 text-white py-5 rounded-2xl font-bold text-xl mt-8 shadow-xl hover:bg-green-700 active:scale-95 transition">
                ุฅุชูุงู ุงูุจูุน (ุชู) โ
            </button>
        </div>
    </main>

    <script>
        // ุงูุชุญูู ูู ุงูุฌูุณุฉ
        (function() {
            const user = sessionStorage.getItem("role");
            if (!user) window.location.href = "index.html";
        })();

        let currentCartItems = [];
        // ูุนุงูุฌุฉ ุงูุจุญุซ ุนูุฏ ูุณุญ ุงูุจุงุฑููุฏ
        document.getElementById('barcodeInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const code = this.value.trim();
                const inventory = JSON.parse(localStorage.getItem('inventory')) || [];
                const product = inventory.find(p => p.barcode === code);

                if (product) {
                    const mode = document.getElementById('saleType').value;
                    const finalPrice = (mode === 'wholesale') ? Number(product.wholesale) : Number(product.retail);
                    
                    currentCartItems.push({ 
                        barcode: product.barcode, 
                        name: product.name, 
                        price: finalPrice 
                    });
                    refreshUI();
                } else {
                    alert("โ๏ธ ูุฐุง ุงูุจุงุฑููุฏ ุบูุฑ ููุฌูุฏ!");
                }
                this.value = '';
            }
        });

        function refreshUI() {
            const list = document.getElementById('cartTable');
            list.innerHTML = currentCartItems.map((item, index) => 
                <tr class="hover:bg-gray-50">
                    <td class="p-3 font-bold text-slate-700">${item.name}</td>
                    <td class="p-3 text-center text-blue-600 font-bold">${item.price.toFixed(2)} $</td>
                    <td class="p-3 text-center">
                        <button onclick="removeItem(${index})" class="text-red-400 font-bold">โ</button>
                    </td>
                </tr>
            ).join('');

            const sum = currentCartItems.reduce((acc, item) => acc + item.price, 0);
            document.getElementById('totalDisplay').innerText = sum.toFixed(2) + " $";
            document.getElementById('itemsCount').innerText = currentCartItems.length;
        }

        function removeItem(idx) {
            currentCartItems.splice(idx, 1);
            refreshUI();
        }

        function confirmTransaction() {
            if (currentCartItems.length === 0) return alert("ุงูุณูุฉ ูุงุฑุบุฉ!");

            const totalAmount = currentCartItems.reduce((acc, item) => acc + item.price, 0);
            const selectedMethod = document.getElementById('fundMethod').value;

            // ุชุญุฏูุซ ุงูุตูุงุฏูู
            let fundsData = JSON.parse(localStorage.getItem('funds')) || { cash: 0, wish: 0, plus: 0, mobi: 0 };
            fundsData[selectedMethod] = (Number(fundsData[selectedMethod]) || 0) + totalAmount;
            localStorage.setItem('funds', JSON.stringify(fundsData));

            // ุชุญุฏูุซ ุงููุฎุฒู
            let invData = JSON.parse(localStorage.getItem('inventory')) || [];
            currentCartItems.forEach(cartItem => {
                let target = invData.find(i => i.barcode === cartItem.barcode);
                if (target && Number(target.qty) > 0) {
                    target.qty = Number(target.qty) - 1;
                }
            });
            localStorage.setItem('inventory', JSON.stringify(invData));

            alert("โ ุชู ุงูุจูุน ูุชุญุฏูุซ ุงูุญุณุงุจุงุช!");
            currentCartItems = [];
            refreshUI();
        }

        function logoutSession() {
            sessionStorage.clear();
            window.location.href = "index.html";
        }
    </script>
</body>
</html>
