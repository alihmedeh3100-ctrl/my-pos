<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ÙƒØ§Ø´ÙŠØ± Ø§Ù„Ù…Ø­Ù„ - Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>body { font-family: 'Cairo', sans-serif; }</style>
</head>
<body class="bg-gray-50 min-h-screen">
    <script>
        (function() {
            const role = sessionStorage.getItem("role");
            if (!role) { window.location.href = "index.html"; }
        })();
        
        function logout() {
            sessionStorage.clear();
            window.location.href = "index.html";
        }
    </script>

    <header class="bg-blue-700 text-white p-4 flex justify-between shadow-lg mb-6">
        <h1 class="text-xl font-bold">ğŸ›’ ÙƒØ§Ø´ÙŠØ± Ø§Ù„Ù…Ø­Ù„</h1>
        <div class="flex gap-4 text-sm">
            <a href="inventory.html" class="bg-blue-900 px-3 py-1 rounded">ğŸ“¦ Ø§Ù„Ù…Ø®Ø²Ù†</a>
            <a href="funds.html" class="bg-blue-900 px-3 py-1 rounded">ğŸ’° Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</a>
            <button onclick="logout()" class="bg-red-500 px-3 py-1 rounded">Ø®Ø±ÙˆØ¬</button>
        </div>
    </header>

    <main class="max-w-6xl mx-auto p-4 grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
            <div class="flex gap-4 mb-6">
                <select id="sale-type" class="border p-3 rounded-xl font-bold bg-gray-50">
                    <option value="retail">Ù…Ø¨ÙŠØ¹ Ù…ÙØ±Ù‚</option>
                    <option value="wholesale">Ù…Ø¨ÙŠØ¹ Ø¬Ù…Ù„Ø©</option>
                </select>
                <input id="barcode-input" type="text" placeholder="Ø§Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù‡Ù†Ø§..." 
                    class="flex-1 border-2 border-blue-500 p-3 rounded-xl outline-none shadow-sm focus:ring-4 focus:ring-blue-100 transition">
            </div>

            <table class="w-full text-right">
                <thead class="bg-gray-100 text-gray-600 border-b">
                    <tr>
                        <th class="p-3">Ø§Ù„Ù‚Ø·Ø¹Ø©</th>
                        <th class="p-3 text-center">Ø§Ù„Ø³Ø¹Ø±</th>
                        <th class="p-3 text-center">Ø­Ø°Ù</th>
                    </tr>
                </thead>
                <tbody id="cart-list" class="divide-y"></tbody>
            </table>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-lg border-t-8 border-green-500 flex flex-col justify-between">
            <div>
                <h2 class="text-xl font-bold mb-4 text-slate-800">Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</h2>
                <label class="text-xs text-gray-400">Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…Ø§Ù„:</label>
                <select id="fund-select" class="w-full border p-4 rounded-xl font-bold text-green-700 bg-green-50 mb-6 outline-none">
                    <option value="cash">Ù†Ù‚Ø¯ÙŠ (Cash)</option>
                    <option value="wish">Wish Money</option>
                    <option value="plus">Cash Plus</option>
                    <option value="mobi">Mobitek</option>
                </select>

                <div class="border-t pt-4 space-y-2">
                    <div class="flex justify-between text-gray-500">
                        <span>Ø§Ù„Ø¹Ø¯Ø¯:</span>
                        <span id="items-count">0</span>
                    </div>
                    <div class="flex justify-between text-3xl font-black text-blue-800">
                        <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span>
                        <span id="total-price">0.00 $</span>
                    </div>
                </div>
            </div>

            <button onclick="completeSale()" class="w-full bg-green-600 text-white py-5 rounded-2xl font-bold text-xl mt-8 shadow-xl hover:bg-green-700 active:scale-95 transition">
                Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¨ÙŠØ¹ (ØªÙ…) âœ…
            </button>
        </div>
    </main>

    <script>
        let currentCart = [];
        document.getElementById('barcode-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const scannedValue = this.value.trim();
                const inventoryData = JSON.parse(localStorage.getItem('inventory')) || [];
                const foundProduct = inventoryData.find(p => p.barcode === scannedValue);

                if (foundProduct) {
                    const type = document.getElementById('sale-type').value;
                    const price = (type === 'wholesale') ? (parseFloat(foundProduct.wholesale)  0) : (parseFloat(foundProduct.retail)  0);
                    
                    currentCart.push({ ...foundProduct, salePrice: price });
                    updateCartUI();
                } else {
                    alert("âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù…Ø®Ø²Ù†! ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¶Ø§ÙØªÙ‡ Ø£ÙˆÙ„Ø§Ù‹.");
                }
                this.value = '';
            }
        });

        function updateCartUI() {
            const list = document.getElementById('cart-list');
            list.innerHTML = currentCart.map((item, index) => 
                <tr class="hover:bg-gray-50">
                    <td class="p-3 font-bold text-slate-700">${item.name}</td>
                    <td class="p-3 text-center text-blue-600 font-bold">${parseFloat(item.salePrice).toFixed(2)} $</td>
                    <td class="p-3 text-center">
                        <button onclick="removeFromCart(${index})" class="text-red-400 font-bold">âœ–</button>
                    </td>
                </tr>
            ).join('');

            const total = currentCart.reduce((sum, item) => sum + item.salePrice, 0);
            document.getElementById('total-price').innerText = total.toFixed(2) + " $";
            document.getElementById('items-count').innerText = currentCart.length;
        }

        function removeFromCart(index) {
            currentCart.splice(index, 1);
            updateCartUI();
        }

        function completeSale() {
            if (currentCart.length === 0) return alert("Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©!");

            const totalAmount = currentCart.reduce((sum, item) => sum + item.salePrice, 0);
            const fundType = document.getElementById('fund-select').value;

            let funds = JSON.parse(localStorage.getItem('funds')) || { cash: 0, wish: 0, plus: 0, mobi: 0 };
            funds[fundType] += totalAmount;
            localStorage.setItem('funds', JSON.stringify(funds));

            let inventory = JSON.parse(localStorage.getItem('inventory')) || [];
            currentCart.forEach(item => {
                let p = inventory.find(inv => inv.barcode === item.barcode);
                if (p && p.qty > 0) p.qty -= 1;
            });
            localStorage.setItem('inventory', JSON.stringify(inventory));

            alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!");
            currentCart = [];
            updateCartUI();
        }
    </script>
</body>
</html>
